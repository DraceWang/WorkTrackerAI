<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkTracker AI - å·¥ä½œè¿½è¸ªå·¥å…·</title>
    <link rel="icon" type="image/x-icon" href="/asserts/WorkTraceAI_16x16.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            position: relative;
        }

        .header .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .header .logo {
            width: 48px;
            height: 48px;
        }

        .header h1 {
            font-size: 2.5em;
            margin: 0;
        }

        .header .version {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .status-item .label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .status-item .value {
            color: #333;
            font-size: 1.8em;
            font-weight: bold;
        }

        .status-item.running {
            background: #d4edda;
        }

        .status-item.stopped {
            background: #f8d7da;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: stretch;
        }

        /* å¼ºåˆ¶ç»Ÿä¸€æ‰€æœ‰æŒ‰é’®æ ·å¼ - ä½¿ç”¨æœ€é«˜ä¼˜å…ˆçº§ */
        .card .button-group button,
        .button-group > button,
        button.success,
        button.danger,
        button.primary,
        button {
            padding: 14px 28px !important;
            border: none !important;
            border-radius: 6px !important;
            font-size: 1.05em !important;
            cursor: pointer !important;
            transition: all 0.3s !important;
            font-weight: 500 !important;
            min-width: 140px !important;
            max-width: none !important;
            width: auto !important;
            height: auto !important;
            text-align: center !important;
            white-space: nowrap !important;
            box-sizing: border-box !important;
            display: inline-block !important;
            line-height: 1.5 !important;
            vertical-align: middle !important;
        }

        button.primary {
            background: #667eea;
            color: white;
        }

        button.primary:hover {
            background: #5568d3;
        }

        button.success {
            background: #28a745;
            color: white;
        }

        button.success:hover {
            background: #218838;
        }

        button.danger {
            background: #dc3545;
            color: white;
        }

        button.danger:hover {
            background: #c82333;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .summaries {
            margin-top: 20px;
        }

        /* ä»Šæ—¥å·¥ä½œæ€»ç»“å¸ƒå±€ï¼šå·¦ä¾§æ—¶é—´è½´ï¼Œå³ä¾§ä»Šæ—¥å°ç»“ */
        .summary-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-top: 20px;
            align-items: flex-start;
        }

        .timeline {
            position: relative;
            padding-left: 40px;
        }

        /* çºµå‘æ—¶é—´è½´çº¿ */
        .timeline::before {
            content: '';
            position: absolute;
            left: 12px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        .timeline .summary-item {
            position: relative;
            margin-bottom: 20px;
        }

        /* æ—¶é—´è½´ä¸Šçš„åœ†ç‚¹ */
        .timeline .summary-item::before {
            content: '';
            position: absolute;
            left: -37px; /* ç²¾ç¡®å¯¹é½çºµå‘æ—¶é—´è½´çº¿ä¸­å¿ƒ */
            top: 20px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #667eea;
            border: 3px solid #ffffff;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.4);
            z-index: 2;
            transition: transform 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
        }

        /* æ‚¬åœæ—¶ä»…åœ†ç‚¹æ”¾å¤§ã€é«˜äº® */
        .timeline .summary-item:hover::before {
            transform: scale(1.25);
            background: #ffb020;
            box-shadow: 0 0 0 3px rgba(255, 176, 32, 0.5);
        }

        /* ç©ºæ®µçš„åœ†ç‚¹æ ·å¼ */
        .timeline .summary-item.empty::before {
            background: #d0d0d0;
            box-shadow: 0 0 0 2px rgba(208, 208, 208, 0.4);
        }

        /* å¤–å±‚å®¹å™¨ä»…ç”¨äºå®šä½åœ†ç‚¹å’Œæ•´ä½“å¸ƒå±€ */
        .summary-item {
            position: relative;
            margin-bottom: 20px;
        }

        /* å†…å±‚å¡ç‰‡è´Ÿè´£èƒŒæ™¯ã€è¾¹æ¡†å’Œæ‚¬åœåŠ¨æ•ˆ */
        .summary-item-inner {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }

        .summary-item-inner:hover {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.35);
            transform: translateX(4px) translateY(-2px);
        }

        /* ç©ºæ®µæ ·å¼ */
        .summary-item.empty .summary-item-inner {
            background: #fafafa;
            border-left-color: #d0d0d0;
        }

        .summary-item-inner .time {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .summary-item-inner .content {
            color: #333;
            line-height: 1.6;
        }

        .summary-item.empty .summary-item-inner .content {
            color: #999;
            font-style: italic;
        }

.daily-overview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px 18px;
            border: 1px solid #e5e7eb;
        }

        .daily-overview h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #333;
        }

        .daily-overview ul {
            list-style: none;
            padding-left: 0;
            color: #333;
            line-height: 1.6;
        }

        .daily-overview li + li {
            margin-top: 4px;
        }

        /* å…¨å±åˆ†æåŠ è½½é®ç½© */
        #analyzeOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 9998;
        }

        #analyzeOverlay .spinner {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.4);
            border-top-color: #ffffff;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        #analyzeOverlay .spinner-text {
            color: #ffffff;
            font-size: 1em;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 900px) {
            .summary-layout {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #dc3545;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);
        }

        .success {
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #message {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 500px;
            min-width: 300px;
            z-index: 9999;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="version" id="appVersion">åŠ è½½ä¸­...</div>
            <div class="logo-container">
                <img src="/asserts/WorkTraceAI.png" alt="WorkTracker Logo" class="logo">
                <h1>WorkTracker AI</h1>
            </div>
            <p>æ™ºèƒ½å·¥ä½œè¿½è¸ªåˆ†æå·¥å…·</p>
        </div>

        <div id="message"></div>

        <!-- çŠ¶æ€å¡ç‰‡ -->
        <div class="card">
            <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
            <div class="status-grid">
                <div class="status-item" id="statusRunning">
                    <div class="label">è¿è¡ŒçŠ¶æ€</div>
                    <div class="value" id="runningStatus">åŠ è½½ä¸­...</div>
                </div>
                <div class="status-item">
                    <div class="label">ä»Šæ—¥æˆªå›¾</div>
                    <div class="value" id="todayCaptures">0</div>
                </div>
                <div class="status-item">
                    <div class="label">ä»Šæ—¥åˆ†æ</div>
                    <div class="value" id="todaySummaries">0</div>
                </div>
                <div class="status-item">
                    <div class="label">å­˜å‚¨å¤§å°</div>
                    <div class="value" id="storageSize">0 MB</div>
                </div>
            </div>

            <div class="button-group">
                <button class="success" onclick="startService()">â–¶ï¸ å¼€å§‹æˆªå±</button>
                <button class="danger" onclick="stopService()">â¸ï¸ åœæ­¢æˆªå±</button>
                <button class="primary" onclick="captureNow()">ğŸ“¸ ç«‹å³æˆªå›¾</button>
                <button class="primary" onclick="analyzeNow()">ğŸ¤– ç«‹å³åˆ†æ</button>
            </div>
        </div>

        <!-- é…ç½®å¡ç‰‡ -->
        <div class="card">
            <h2>âš™ï¸ é…ç½®è®¾ç½®</h2>
            <form id="configForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>æˆªå›¾é—´éš”ï¼ˆç§’ï¼‰</label>
                        <input type="number" id="captureInterval" min="1" max="60" value="3">
                    </div>
                    <div class="form-group">
                        <label>å›¾ç‰‡è´¨é‡</label>
                        <input type="number" id="quality" min="1" max="100" value="75">
                    </div>
                    <div class="form-group">
                        <label>åˆ†æé—´éš”ï¼ˆåˆ†é’Ÿï¼‰</label>
                        <input type="number" id="analysisInterval" min="10" max="180" value="60">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>å·¥ä½œå¼€å§‹æ—¶é—´</label>
                        <input type="time" id="startTime" value="09:00">
                    </div>
                    <div class="form-group">
                        <label>å·¥ä½œç»“æŸæ—¶é—´</label>
                        <input type="time" id="endTime" value="18:00">
                    </div>
                    <div class="form-group">
                        <label>æ•°æ®ä¿ç•™å¤©æ•°</label>
                        <input type="number" id="retentionDays" min="1" max="365" value="30">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>AI æä¾›å•†</label>
                        <select id="aiProvider">
                            <option value="openai">OpenAI</option>
                            <option value="claude">Claude</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="qwen">é€šä¹‰åƒé—® (Qwen)</option>
                            <option value="doubao">è±†åŒ… (Doubao)</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Base URL</label>
                        <input type="text" id="baseURL" placeholder="å¦‚: https://api.openai.com/v1">
                    </div>
                    <div class="form-group">
                        <label>API å¯†é’¥</label>
                        <input type="password" id="apiKey" placeholder="è¯·è¾“å…¥ API å¯†é’¥">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>AI æ¨¡å‹</label>
                        <select id="aiModel">
                            <option value="">è¯·å…ˆæµ‹è¯•è¿æ¥è·å–æ¨¡å‹åˆ—è¡¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="primary" onclick="testConnection()">ğŸ”Œ æµ‹è¯•è¿æ¥</button>
                    </div>
                </div>

                <button type="submit" class="success">ğŸ’¾ ä¿å­˜é…ç½®</button>
            </form>
        </div>

        <!-- å·¥ä½œæ€»ç»“å¡ç‰‡ -->
        <div class="card">
            <h2>ğŸ“ ä»Šæ—¥å·¥ä½œæ€»ç»“</h2>
            <div class="summary-layout">
                <div class="timeline" id="summariesTimeline">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
                <div class="daily-overview">
                    <h3>ğŸ“Œ ä»Šæ—¥å°ç»“</h3>
                    <ul id="dailySummaryList">
                        <li>åŠ è½½ä¸­...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API åŸºç¡€è·¯å¾„
        const API_BASE = '/api';

        // åŠ è½½çŠ¶æ€
        async function loadStatus() {
            try {
                const response = await fetch(`${API_BASE}/service/status`);
                const data = await response.json();

                document.getElementById('runningStatus').textContent = data.running ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
                document.getElementById('statusRunning').className = data.running ? 'status-item running' : 'status-item stopped';
                document.getElementById('todayCaptures').textContent = data.today_captures;
                document.getElementById('todaySummaries').textContent = data.today_summaries;
            } catch (error) {
                console.error('åŠ è½½çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // åŠ è½½å­˜å‚¨ç»Ÿè®¡
        async function loadStorageStats() {
            try {
                const response = await fetch(`${API_BASE}/stats/storage`);
                const data = await response.json();
                const sizeMB = (data.total_size / 1024 / 1024).toFixed(2);
                document.getElementById('storageSize').textContent = `${sizeMB} MB`;
            } catch (error) {
                console.error('åŠ è½½å­˜å‚¨ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const response = await fetch(`${API_BASE}/config`);
                const data = await response.json();

                document.getElementById('captureInterval').value = data.capture.interval;
                document.getElementById('quality').value = data.capture.quality;
                document.getElementById('analysisInterval').value = data.schedule.analysis_interval;
                document.getElementById('startTime').value = data.schedule.start_time;
                document.getElementById('endTime').value = data.schedule.end_time;
                document.getElementById('retentionDays').value = data.storage.retention_days;
                document.getElementById('aiProvider').value = data.ai.provider;
                document.getElementById('baseURL').value = data.ai.base_url || '';

                // è®¾ç½®æ¨¡å‹é€‰é¡¹
                const modelSelect = document.getElementById('aiModel');
                if (data.ai.model) {
                    // å¦‚æœå·²æœ‰æ¨¡å‹é…ç½®ï¼Œæ·»åŠ åˆ°é€‰é¡¹å¹¶é€‰ä¸­
                    modelSelect.innerHTML = `<option value="${data.ai.model}">${data.ai.model}</option>`;
                    modelSelect.value = data.ai.model;
                }

                if (data.ai.api_key) {
                    document.getElementById('apiKey').value = data.ai.api_key;
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        // åŠ è½½ä»Šæ—¥æ€»ç»“ï¼ˆå·¦ä¾§æ—¶é—´è½´ + å³ä¾§ä»Šæ—¥å°ç»“ï¼‰
        async function loadSummaries() {
            try {
                const response = await fetch(`${API_BASE}/summaries`);
                const data = await response.json();

                const timelineContainer = document.getElementById('summariesTimeline');
                const dailyList = document.getElementById('dailySummaryList');

                if (!Array.isArray(data) || data.length === 0) {
                    if (timelineContainer) {
                        timelineContainer.innerHTML = '<div class="loading">æš‚æ— å·¥ä½œæ€»ç»“</div>';
                    }
                    if (dailyList) {
                        dailyList.innerHTML = '<li>æš‚æ— å·¥ä½œæ€»ç»“</li>';
                    }
                    return;
                }

                // æŒ‰å¼€å§‹æ—¶é—´æ’åºï¼Œä¿è¯æ—¶é—´è½´ä»æ—©åˆ°æ™š
                const sorted = data.slice().sort((a, b) => new Date(a.start_time) - new Date(b.start_time));

                if (timelineContainer) {
                    timelineContainer.innerHTML = sorted.map(s => {
                        const isEmpty = s.summary === 'æš‚æ— æˆªå±å†…å®¹';
                        const emptyClass = isEmpty ? 'empty' : '';
                        return `
                            <div class="summary-item ${emptyClass}">
                                <div class="summary-item-inner">
                                    <div class="time">${formatTime(s.start_time)} - ${formatTime(s.end_time)}</div>
                                    <div class="content">${s.summary}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                if (dailyList) {
                    // ã€Œä»Šæ—¥å°ç»“ã€ä¸ºæŒ‰å¤©èšåˆçš„å·¥ä½œè¦ç‚¹åˆ—è¡¨ï¼š
                    // 1) è¿‡æ»¤ç©ºæ®µï¼ˆâ€œæš‚æ— æˆªå±å†…å®¹â€ï¼‰ï¼›
                    // 2) å°†å„æ—¶é—´æ®µ summary ä¸­çš„ 1.xxx;2.xxx;... æ‹†åˆ†ä¸ºå•æ¡å·¥ä½œé¡¹ï¼›
                    // 3) å¯¹ç›¸åŒå†…å®¹å»é‡ï¼›
                    // 4) é‡æ–°æŒ‰ 1.,2.,3. è¿›è¡Œç¼–å·è¾“å‡ºï¼Œä¸æ˜¾ç¤ºæ—¶é—´æ®µã€‚
                    const nonEmptySummaries = sorted.filter(s => s.summary && s.summary !== 'æš‚æ— æˆªå±å†…å®¹');

                    if (nonEmptySummaries.length === 0) {
                        dailyList.innerHTML = '<li>æš‚æ— å·¥ä½œæ€»ç»“</li>';
                    } else {
                        const itemSet = new Set();
                        nonEmptySummaries.forEach(s => {
                            const raw = String(s.summary);
                            // ç”¨åˆ†å·åˆ‡åˆ†å¤šä¸ªå·¥ä½œé¡¹
                            raw.split(';').forEach(part => {
                                let text = part.trim();
                                if (!text) return;
                                // å»æ‰å‰ç¼€ç¼–å·ï¼Œå¦‚ "1.", "2.", "1ã€" ç­‰
                                text = text.replace(/^\s*\d+[\.ã€ï¼\)]\s*/, '');
                                // å»æ‰å¼€å¤´çš„â€œæœ¬æ—¶æ®µ/è¯¥æ—¶æ®µ/åœ¨æœ¬æ—¶é—´æ®µå†…â€ç­‰æªè¾ï¼Œä½¿å…¶æ›´åƒæ•´å¤©çš„å·¥ä½œé¡¹
                                text = text.replace(/^(æœ¬æ—¶æ®µ|è¯¥æ—¶æ®µ|åœ¨æœ¬æ—¶é—´æ®µå†…|åœ¨æ­¤æ—¶é—´æ®µå†…|åœ¨è¯¥æ—¶é—´æ®µå†…)\s*/, '');
                                if (!text) return;
                                itemSet.add(text);
                            });
                        });

                        const items = Array.from(itemSet);
                        if (items.length === 0) {
                            dailyList.innerHTML = '<li>æš‚æ— å·¥ä½œæ€»ç»“</li>';
                        } else {
                            dailyList.innerHTML = items.map((text, idx) => `
                                <li>${idx + 1}. ${text}ï¼›</li>
                            `).join('');
                        }
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ€»ç»“å¤±è´¥:', error);
                const timelineContainer = document.getElementById('summariesTimeline');
                const dailyList = document.getElementById('dailySummaryList');
                if (timelineContainer) {
                    timelineContainer.innerHTML = '<div class="loading">æš‚æ— å·¥ä½œæ€»ç»“</div>';
                }
                if (dailyList) {
                    dailyList.innerHTML = '<li>æš‚æ— å·¥ä½œæ€»ç»“</li>';
                }
            }
        }

        // å¯åŠ¨æœåŠ¡
        async function startService() {
            try {
                const response = await fetch(`${API_BASE}/service/start`, { method: 'POST' });
                const data = await response.json();
                showMessage(data.message, 'success');
                loadStatus();
            } catch (error) {
                showMessage('å¯åŠ¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åœæ­¢æœåŠ¡
        async function stopService() {
            try {
                const response = await fetch(`${API_BASE}/service/stop`, { method: 'POST' });
                const data = await response.json();
                showMessage(data.message, 'success');
                loadStatus();
            } catch (error) {
                showMessage('åœæ­¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç«‹å³æˆªå›¾
        async function captureNow() {
            try {
                const response = await fetch(`${API_BASE}/screenshots/capture`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ screen_index: 0 })
                });
                const data = await response.json();
                showMessage('æˆªå›¾æˆåŠŸ!', 'success');
                loadStatus();
            } catch (error) {
                showMessage('æˆªå›¾å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å°†æœ¬åœ°æ—¶é—´è½¬æ¢ä¸º RFC3339 å­—ç¬¦ä¸²ï¼ŒåŒ…å«æœ¬æœºå®é™…æ—¶åŒºåç§»
        // ä¾‹å¦‚ï¼š2025-01-02T09:00:00+08:00 æˆ– 2025-01-02T09:00:00+09:00
        function toLocalISOString(date) {
            const tzo = -date.getTimezoneOffset(); // åˆ†é’Ÿï¼Œä¸œå…«åŒºä¸º +480
            const dif = tzo >= 0 ? '+' : '-';
            const pad = (num) => String(Math.floor(Math.abs(num))).padStart(2, '0');

            const year = date.getFullYear();
            const month = pad(date.getMonth() + 1);
            const day = pad(date.getDate());
            const hours = pad(date.getHours());
            const minutes = pad(date.getMinutes());
            const seconds = pad(date.getSeconds());

            // ç”Ÿæˆå½¢å¦‚ YYYY-MM-DDTHH:mm:ss+HH:MM çš„å­—ç¬¦ä¸²ï¼Œå…¼å®¹åç«¯ time.RFC3339 è§£æ
            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}${dif}${pad(tzo / 60)}:${pad(tzo % 60)}`;
        }

        // æ˜¾ç¤º/éšè—å…¨å±åŠ è½½é®ç½©
        function setAnalyzing(loading) {
            let overlay = document.getElementById('analyzeOverlay');
            if (!overlay && loading) {
                overlay = document.createElement('div');
                overlay.id = 'analyzeOverlay';
                overlay.innerHTML = '<div class="spinner"></div><div class="spinner-text">æ­£åœ¨åˆ†æä»Šæ—¥å·¥ä½œï¼Œè¯·ç¨å€™...</div>';
                document.body.appendChild(overlay);
            }
            if (overlay) {
                overlay.style.display = loading ? 'flex' : 'none';
            }
        }

        // ç«‹å³åˆ†æ
        async function analyzeNow() {
            try {
                const now = new Date();
                // è·å–ä»Šå¤©çš„å¼€å§‹æ—¶é—´ï¼ˆæœ¬åœ°00:00:00ï¼‰
                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);

                console.log('åˆ†ææ—¶é—´èŒƒå›´:');
                console.log('  å¼€å§‹:', toLocalISOString(todayStart));
                console.log('  ç»“æŸ:', toLocalISOString(now));

                // æ˜¾ç¤ºå…¨å±ç­‰å¾…é®ç½©
                setAnalyzing(true);

                const response = await fetch(`${API_BASE}/summaries/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start_time: toLocalISOString(todayStart),
                        end_time: toLocalISOString(now)
                    })
                });

                const data = await response.json();

                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    throw new Error(data.error || 'åˆ†æè¯·æ±‚å¤±è´¥');
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
                if (data.error) {
                    showMessage('âŒ ' + data.error, 'error');
                    return;
                }

                showMessage('âœ… åˆ†æå®Œæˆï¼å·²ç”Ÿæˆå·¥ä½œæ€»ç»“', 'success');
                await loadSummaries();
                await loadStatus();
            } catch (error) {
                showMessage('âŒ åˆ†æå¤±è´¥: ' + error.message, 'error');
            } finally {
                // æ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½éšè—ç­‰å¾…é®ç½©
                setAnalyzing(false);
            }
        }

        // æµ‹è¯• AI è¿æ¥å¹¶è·å–æ¨¡å‹åˆ—è¡¨
        async function testConnection() {
            const provider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('apiKey').value;
            const baseURL = document.getElementById('baseURL').value;

            if (!apiKey) {
                showMessage('è¯·å…ˆè¾“å…¥ API å¯†é’¥', 'error');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const modelSelect = document.getElementById('aiModel');
            modelSelect.innerHTML = '<option value="">æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨...</option>';
            modelSelect.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/ai/test-connection`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: provider,
                        api_key: apiKey,
                        base_url: baseURL
                    })
                });

                if (!response.ok) {
                    throw new Error('è¿æ¥æµ‹è¯•å¤±è´¥');
                }

                const data = await response.json();

                // å¡«å……æ¨¡å‹åˆ—è¡¨
                if (data.models && data.models.length > 0) {
                    modelSelect.innerHTML = data.models.map(m =>
                        `<option value="${m.id}">${m.name || m.id}</option>`
                    ).join('');
                    showMessage('âœ… è¿æ¥æˆåŠŸï¼å·²è·å– ' + data.models.length + ' ä¸ªå¯ç”¨æ¨¡å‹', 'success');
                } else {
                    modelSelect.innerHTML = '<option value="">æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹</option>';
                    showMessage('è¿æ¥æˆåŠŸï¼Œä½†æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹', 'error');
                }
                modelSelect.disabled = false;

            } catch (error) {
                modelSelect.innerHTML = '<option value="">è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®</option>';
                modelSelect.disabled = false;
                showMessage('âŒ è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¿å­˜é…ç½®
        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const modelSelect = document.getElementById('aiModel');
            const selectedModel = modelSelect.value;

            if (!selectedModel) {
                showMessage('è¯·å…ˆæµ‹è¯•è¿æ¥å¹¶é€‰æ‹©ä¸€ä¸ª AI æ¨¡å‹', 'error');
                return;
            }

            const config = {
                capture: {
                    interval: parseInt(document.getElementById('captureInterval').value),
                    selected_screens: [0],
                    quality: parseInt(document.getElementById('quality').value),
                    enabled: true
                },
                schedule: {
                    start_time: document.getElementById('startTime').value,
                    end_time: document.getElementById('endTime').value,
                    work_days: [1, 2, 3, 4, 5],
                    analysis_interval: parseInt(document.getElementById('analysisInterval').value),
                    enabled: true
                },
                ai: {
                    provider: document.getElementById('aiProvider').value,
                    api_key: document.getElementById('apiKey').value,
                    model: selectedModel,
                    base_url: document.getElementById('baseURL').value,
                    endpoint: "",
                    max_tokens: 2000,
                    temperature: 0.3,
                    max_images: 20
                },
                storage: {
                    data_dir: "./data",
                    retention_days: parseInt(document.getElementById('retentionDays').value),
                    compression: true
                },
                server: {
                    port: 9527,
                    host: "localhost",
                    enable_cors: true,
                    auto_open_browser: true
                }
            };

            try {
                const response = await fetch(`${API_BASE}/config`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const data = await response.json();
                showMessage('âœ… ' + data.message + 'ï¼Œé…ç½®å·²ç”Ÿæ•ˆï¼', 'success');
                // ä¿å­˜åé‡æ–°åŠ è½½é…ç½®ä»¥ç¡®ä¿åŒæ­¥
                setTimeout(() => loadConfig(), 1000);
            } catch (error) {
                showMessage('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message, 'error');
            }
        });

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(msg, type) {
            const container = document.getElementById('message');
            container.className = type;
            container.textContent = msg;
            container.style.display = 'block';
            setTimeout(() => {
                container.style.display = 'none';
                container.textContent = '';
                container.className = '';
            }, 5000); // å¢åŠ åˆ°5ç§’,æ›´æ˜æ˜¾
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }

        // åˆå§‹åŒ–
        loadVersion();
        loadStatus();
        loadStorageStats();
        loadConfig();
        loadSummaries();

        // å®šæ—¶åˆ·æ–°çŠ¶æ€
        setInterval(loadStatus, 5000);
        setInterval(loadStorageStats, 30000);

        // åŠ è½½ç‰ˆæœ¬ä¿¡æ¯
        async function loadVersion() {
            try {
                const response = await fetch(`${API_BASE}/version`);
                const data = await response.json();
                document.getElementById('appVersion').textContent = 'v' + data.version;
            } catch (error) {
                console.error('åŠ è½½ç‰ˆæœ¬å¤±è´¥:', error);
                document.getElementById('appVersion').textContent = 'v1.2.0';
            }
        }
    </script>
</body>
</html>
